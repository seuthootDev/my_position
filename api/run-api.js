const axios = require('axios');

module.exports = async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).json({ message: 'Method not allowed' });
  }

  const { age, income } = req.body;

  const url = "https://kosis.kr/openapi/Param/statisticsParameterData.do";
  const params = {
    method: "getList",
    apiKey: "N2Q5OGNkNjU0MjNkNTdhNWEwMDRlNjI3N2NmY2YxYTg=",
    itmId: "T001",
    objL1: "ALL",
    objL2: "ALL",
    objL3: "",
    objL4: "",
    objL5: "",
    objL6: "",
    objL7: "",
    objL8: "",
    format: "json",
    jsonVD: "Y",
    prdSe: "Y",
    newEstPrdCnt: 1,
    orgId: 101,
    tblId: "DT_1EP_2006"
  };

  try {
    const response = await axios.get(url, { params });
    const data = response.data;

    const incomePositions = {
        "85ë§Œì› ë¯¸ë§Œ": [
            "ğŸ˜ ì‚¬íšŒì˜ ìˆ¨ì€ ê³ ìˆ˜... ì•„ë‹ˆ, ìƒì¡´ ë§ˆìŠ¤í„°! ğŸ’° ì•„ë‚Œì˜ ë‹¬ì¸!",
            "ğŸ ì•Œëœ°í•¨ì˜ ëíŒì™•! í˜¹ì‹œ ì¿ í°ë¶ ë“¤ê³  ë‹¤ë‹ˆì‹œë‚˜ìš”? ğŸ“–",
            "ğŸ’¡ ì•Œë°” ì›”ê¸‰ì´ ìƒí™œë¹„... í•˜ì§€ë§Œ ê¿ˆê³¼ í¬ë§ì€ ê°€ë“! ğŸŒˆ",
            "ğŸ’³ ì²´í¬ì¹´ë“œ ê¸ì„ ë•Œë§ˆë‹¤ ì‹¬ì¥ì´ ì² ë ! ğŸ« ",
            "ğŸš ìì·¨ í•„ìˆ˜í…œ: ìŒ€, ë‹¬ê±€, ê°„ì¥ì´ë©´ í•œ ë‹¬ ë²„í‹´ë‹¤! ğŸ’ª"
        ],
        "85ï½150ë§Œì› ë¯¸ë§Œ": [
            "ğŸœ í¸ì˜ì  VIP ê³ ê°! ë¼ë©´ ì‹ ìƒ ë‚˜ì˜¤ë©´ ì œì¼ ë¨¼ì € ì•Œì§€? ğŸ¤£",
            "ğŸš² ì¶œí‡´ê·¼ì€ ë”°ë¦‰ì´! ì§€í•˜ì²  ê¸°ë³¸ìš”ê¸ˆë„ ë¶€ë‹´ë˜ëŠ” ê·¸ ëŠë‚Œ... ğŸ˜µ",
            "ğŸï¸ ë°°ë‹¬ì•± ì¥ë°”êµ¬ë‹ˆì— ë‹´ê³  ê²°ì œëŠ” ì·¨ì†Œ... ì˜¤ëŠ˜ë„ ì§ì ‘ í•´ë¨¹ëŠ”ë‹¤! ğŸ³",
            "ğŸ¬ ì˜í™”ëŠ” ì¿ íŒ¡í”Œë ˆì´ë¡œ! ê·¹ì¥ì€ ì‚¬ì¹˜... ğŸ˜­",
            "ğŸ“… ì›”ê¸‰ë‚ ë¶€í„° ì‹œì‘ë˜ëŠ” ê·¹í•œì˜ 30ì¼ ì„œë°”ì´ë²Œ! ğŸ•ï¸"
        ],
        "150ï½250ë§Œì› ë¯¸ë§Œ": [
            "ğŸ“‰ í……ì¥ê³¼ì˜ ì‹¸ì›€! ë§¤ë‹¬ 25ì¼ì´ 'Doomsday' ğŸ˜µ",
            "â˜• ì¹´í˜ ê°ˆ ë•Œ, 'ì•„ë©”ë¦¬ì¹´ë…¸ë§Œ ë§ˆì‹¤ê²Œìš”'ê°€ ì…ë²„ë¦‡! ğŸ’¸",
            "ğŸ“Š ì›”ê¸‰ ë£¨íŒ¡ ì¤‘? í˜„ì‹¤ì€ ìƒí™œë¹„ë¡œ ì¦ë°œ ì¤‘... ğŸ’€",
            "ğŸ’¡ ë°ì´í„° ë¬´ì œí•œ? No! ì™€ì´íŒŒì´ ì—†ëŠ” ê³³ì€ ê³µí¬ ê·¸ ìì²´! ğŸ“µ",
            "ğŸ›’ ì¥ë°”êµ¬ë‹ˆì— ë„£ê³  ê²°ì œëŠ” ë‚˜ì¤‘ì—... ê·¸ë¦¬ê³  ê²°êµ­ ì‚­ì œ ğŸ˜”"
        ],
        "250ï½350ë§Œì› ë¯¸ë§Œ": [
            "ğŸ“ˆ ì´ì œ ë§‰ ì¤‘ì‚°ì¸µ ì…ì„± ì¤€ë¹„! í•œ ê±¸ìŒì”© ìœ„ë¡œ ê°€ë³´ìê³ ! ğŸ”¥",
            "ğŸš† 'ëŒ€ì¤‘êµí†µ ì •ê¸°ê¶Œ'ì´ ì œì¼ íš¨ìœ¨ì ì¸ ì†Œë¹„ë¼ê³  ë¯¿ëŠ” ë‹¹ì‹ ! ğŸŸï¸",
            "ğŸ¥‘ ê±´ê°• ì±™ê¸¸ ì—¬ìœ ëŠ” ìƒê²¼ì§€ë§Œ, ì•„ë³´ì¹´ë„ëŠ” ì•„ì§ ì‚¬ì¹˜?! ğŸ¤”",
            "ğŸ ì¹œêµ¬ ìƒì¼ ì„ ë¬¼? 3ë§Œì› ì„ ì—ì„œ ê³ ë¯¼í•˜ëŠ” í˜„ì‹¤ì  ê°ê°! ğŸ‚",
            "ğŸ• 1ì¸ 1íŒì€ ë¶€ë‹´... ë°˜ë°˜ ë‚˜ëˆ  ë¨¹ê¸°ê°€ êµ­ë£°! ğŸ˜…"
        ],
        "350ï½450ë§Œì› ë¯¸ë§Œ": [
            "ğŸ’¼ ì§ì¥ì¸ ë£¨í‚¤! ì›”ê¸‰ë‚  ì €ê°€ ì»¤í”¼ìƒµ ë§ê³ , ìŠ¤íƒ€ë²…ìŠ¤ ê°€ëŠ” ì—¬ìœ ? â˜•",
            "ğŸ– ê°€ë” ì‚¼ê²¹ì‚´ 3ì¸ë¶„ í˜¼ì ë¨¹ì–´ë„ ì§€ê°‘ì´ ì•ˆ ì•„í”ˆ ë‹¨ê³„! ğŸ¥©",
            "ğŸš• ì§€í•˜ì²  ëŠê¸°ë©´ íƒì‹œ íƒˆê¹Œ ë§ê¹Œ ì‹¬ê°í•œ ê³ ë¯¼ ì‹œì‘! ğŸ¤¯",
            "ğŸ¿ ê²¨ìš¸ì—” ë³´ë“œ, ì—¬ë¦„ì—” ìº í•‘! ì·¨ë¯¸ìƒí™œ ì¡°ê¸ˆì”© ëŠ˜ë ¤ê°€ëŠ” ì¤‘! ğŸ•ï¸",
            "ğŸ“… 1ë…„ì— í•œ ë²ˆì¯¤ì€ í•´ì™¸ì—¬í–‰ ê°€ë³¼ê¹Œ ê³ ë¯¼ ì‹œì‘! âœˆï¸"
        ],
        "450ï½550ë§Œì› ë¯¸ë§Œ": [
            "ğŸ’³ ì†Œì†Œí•œ í”Œë ‰ìŠ¤ ê°€ëŠ¥! ì¹œêµ¬ë“¤ ì‚¬ì´ì—ì„œ 'í•œ í„± ì´!' ë“£ëŠ” ìˆ˜ì¤€! ğŸ–",
            "ğŸ¨ ê°€ë” í˜¸ìº‰ìŠ¤ë„ ê°€ëŠ” ì§ì¥ì¸, 'ì¼ìƒì´ ì—¬í–‰'ì´ ëª©í‘œ! âœˆï¸",
            "ğŸ“± ì‹ í˜• ì•„ì´í° ë‚˜ì˜¤ë©´ ì‚´ê¹Œ ë§ê¹Œ ì§„ì§€í•˜ê²Œ ê³ ë¯¼í•˜ëŠ” ë‹¨ê³„! ğŸ",
            "ğŸ· 'ë§¥ì£¼ ëŒ€ì‹  ì™€ì¸ í•œ ì” ì–´ë•Œ?' ë¶„ìœ„ê¸° ì±™ê¸°ê¸° ì‹œì‘! ğŸ¥‚",
            "ğŸ›ï¸ ë°±í™”ì  ì‡¼í•‘ ê°€ë©´ ê°€ê²©í‘œë¶€í„° ì•ˆ ë³´ê³  ë³´ëŠ” ìì‹  ë°œê²¬! ğŸ˜"
        ],
        "550ï½650ë§Œì› ë¯¸ë§Œ": [
            "ğŸš— ì¶œí‡´ê·¼ ì§€í•˜ì² ? ì´ì œ ìŠ¬ìŠ¬ ë‚´ ì°¨ ë½‘ì„ ê³ ë¯¼í•˜ëŠ” ë‹¨ê³„! ğŸï¸",
            "ğŸ’¸ 2ì°¨ê¹Œì§€ëŠ” ê±±ì • ì—†ì´ ì  ìˆ˜ ìˆëŠ” ë‹¹ì‹ , ë¦¬ìŠ¤í™! ğŸ™Œ",
            "ğŸ  ì›ë£¸ íƒˆì¶œ D-100?! ë‚´ ì§‘ ë§ˆë ¨ì„ ê¿ˆê¾¸ëŠ” í˜„ì‹¤ì ì¸ ìì‚°ê°€! ğŸ”‘",
            "ğŸ½ï¸ ë ˆìŠ¤í† ë‘ ê°ˆ ë•Œ 'ì¶”ì²œ ë©”ë‰´ ì£¼ì„¸ìš”'ë¼ê³  ë§í•  ìˆ˜ ìˆëŠ” ìì‹ ê°! ğŸ˜",
            "ğŸ‘œ ëª…í’ˆ ë¸Œëœë“œ, ì´ì œ êµ¬ê²½ë§Œ í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ í•œ ë²ˆì¯¤ ê³ ë¯¼ë„ í•œë‹¤! ğŸ’"
        ],
        "650ï½800ë§Œì› ë¯¸ë§Œ": [
            "ğŸ  'ë¶€ë™ì‚° ì–´í”Œ' ìì£¼ ì¼œê³  ìˆëŠ” ë‹¹ì‹ ! ë‚´ ì§‘ ë§ˆë ¨ì´ ëˆˆì•? ğŸ‘€",
            "ğŸ· ì†Œì£¼ ëŒ€ì‹  ì™€ì¸ìœ¼ë¡œ ê°ˆì•„íƒ„ ë‹¹ì‹ , ì´ì   ë¶„ìœ„ê¸°ë¥¼ ì¦ê¸´ë‹¤! ğŸ¶",
            "ğŸ’¼ 'ì¼ë³´ë‹¤ ëˆì´ ë§ì•„ì•¼ í•œë‹¤'ëŠ” ì² í•™ì„ ê°€ì§€ê¸° ì‹œì‘í•˜ëŠ” ë‹¨ê³„! ğŸ“Š",
            "ğŸ’³ í•œ ë‹¬ ì¹´ë“œê°’ ë³´ê³ ë„ í¬ê²Œ ë™ìš”í•˜ì§€ ì•ŠëŠ” ê°•ì²  ë©˜íƒˆ! ğŸ¤–",
            "âœˆï¸ ë¹„í–‰ê¸° íƒˆ ë•Œ 'ì´ì½”ë…¸ë¯¸? ë¹„ì¦ˆë‹ˆìŠ¤?' ì‚´ì§ ê³ ë¯¼í•˜ëŠ” ì—¬ìœ ! ğŸ’º"
        ],
        "800ï½1000ë§Œì› ë¯¸ë§Œ": [
            "ğŸ¤‘ ì¢€ ì¹˜ëŠ” ì‚¬ëŒ! ì£¼ë³€ì—ì„œ 'íˆ¬ì ì¢€ ê°€ë¥´ì³ì¤˜' ì†Œë¦¬ ë“£ì§€? ğŸ¤©",
            "ğŸ’ ëª…í’ˆ ì‡¼í•‘í•  ë•Œ ê°€ê²©ì„ ë¨¼ì € ì•ˆ ë³´ê²Œ ë˜ëŠ” ë‹¨ê³„?! ğŸ‘”",
            "âœˆï¸ ì´ì œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ì„ í•œ ë²ˆ íƒ€ë³¼ê¹Œ? ìŠ¹ê¸‰ ê³ ë¯¼ ì‹œì‘! ğŸ’º",
            "ğŸ­ ê³µì—°ì´ë‚˜ ì „ì‹œíšŒ VIPì„ì´ ë” ìµìˆ™í•´ì§€ëŠ” ë‹¹ì‹ ! ğŸŸï¸",
            "ğŸ–ï¸ 'íœ´ì–‘ì§€? ì¼ì£¼ì¼ì¯¤ì€ ìˆì–´ì•¼ íë§ë˜ì§€~' ì—¬ìœ ë¥¼ ì•„ëŠ” ë‹¨ê³„! ğŸŒŠ"
        ],
        "1000ë§Œì› ì´ìƒ": [
            "ğŸš€ ëŒ€í•œë¯¼êµ­ ìƒìœ„ 1% í´ëŸ½ ê°€ì… ì™„ë£Œ! í˜¹ì‹œ ì¬ë²Œ 3ì„¸ì„¸ìš”? ğŸ‘‘",
            "ğŸï¸ ì›”ê¸‰ì´ ì•„ë‹ˆë¼ ìì‚°ì´ ëˆì„ ë²„ëŠ” ë‹¨ê³„... í˜¹ì‹œ FIREì¡±? ğŸ”¥",
            "ğŸ’° 'ì´ ì •ë„ë©´ ì¶©ë¶„í•´'ë¼ëŠ” ë§ì„ ì•ˆ í•´ë³¸ ì‚¬ëŒ! ì§„ì •í•œ í”Œë ‰ì„œ! ğŸ¦",
            "ğŸ¾ í´ëŸ½ VIP, í˜¸í…” ìŠ¤ìœ„íŠ¸ë£¸, í”„ë¼ì´ë¹— ì œíŠ¸... ì–´ë””ê¹Œì§€ ê°€ë´¤ë‹ˆ? ğŸ›©ï¸",
            "ğŸ© 'ëˆì´ ì•„ë‹ˆë¼ ì‹œê°„ì´ ë¬¸ì œì•¼'ë¼ëŠ” ë§ì´ í˜„ì‹¤ì´ ë˜ëŠ” ìˆœê°„! â³"
        ]
    };

    const lst = Object.keys(incomePositions);

    const getIncomeMessage = (income) => {
      const messages = incomePositions[income] || ["ğŸ˜¶ í•´ë‹¹í•˜ëŠ” ë©”ì‹œì§€ê°€ ì—†ë„¤...!"];
      return messages[Math.floor(Math.random() * messages.length)];
    };

    const df = data.map(item => ({
      ì—°ë ¹ëŒ€: item.C2_NM,
      ì†Œë“: item.C1_NM,
      ë°±ë¶„ìœ„: parseFloat(item.DT)
    }));

    df.sort((a, b) => a.ì†Œë“.localeCompare(b.ì†Œë“));

    const cnt = lst.indexOf(income);
    const ë°±ë¶„ìœ„ê°’ = df.find(d => d.ì—°ë ¹ëŒ€ === age && d.ì†Œë“ === income).ë°±ë¶„ìœ„;
    const mean = df.find(d => d.ì—°ë ¹ëŒ€ === age && d.ì†Œë“ === "ì¤‘ìœ„ì†Œë“").ë°±ë¶„ìœ„;
    const avg = df.find(d => d.ì—°ë ¹ëŒ€ === age && d.ì†Œë“ === "í‰ê· ì†Œë“").ë°±ë¶„ìœ„;

    let sum = 0;
    for (let i = cnt; i >= 0; i--) {
      const unit = df.find(d => d.ì—°ë ¹ëŒ€ === age && d.ì†Œë“ === lst[i]).ë°±ë¶„ìœ„;
      sum += unit;
    }

    const message = getIncomeMessage(income);

    return res.status(200).json({
      message,
      status: "success",
      data: {
        percentile: ë°±ë¶„ìœ„ê°’,
        mean: parseFloat(mean.toFixed(1)),
        average: parseFloat(avg.toFixed(1)),
        position: sum > 50 ? "ìƒìœ„" : "í•˜ìœ„",
        percentage: sum > 50 ? parseFloat((100 - sum).toFixed(1)) : parseFloat(sum.toFixed(1))
      }
    });

  } catch (error) {
    return res.status(500).json({
      message: `ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì—ëŸ¬: ${error.message})`,
      status: "error"
    });
  }
};